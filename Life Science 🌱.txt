import React, { useState, useRef, useEffect } from 'react';
import { Sparkles, HelpCircle, Trophy } from 'lucide-react';

const MixtureLabGame = () => {
  const [currentLevel, setCurrentLevel] = useState(0);
  const [draggedMethod, setDraggedMethod] = useState(null);
  const [isAnimating, setIsAnimating] = useState(false);
  const [showHint, setShowHint] = useState(false);
  const [gameComplete, setGameComplete] = useState(false);
  const [showSuccess, setShowSuccess] = useState(false);
  const [animationState, setAnimationState] = useState('idle');
  const [confetti, setConfetti] = useState([]);
  const bowlRef = useRef(null);
  const dragRef = useRef({ x: 0, y: 0, isDragging: false });

  const levels = [
    {
      mixture: 'Rice + Stones',
      image: 'ğŸšğŸª¨',
      correctMethod: 'handpicking',
      description: 'Pick out the stones from rice'
    },
    {
      mixture: 'Sand + Water',
      image: 'ğŸ’§ğŸ–',
      correctMethod: 'sedimentation',
      alternateMethod: 'filtration',
      description: 'Let sand settle or filter it out'
    },
    {
      mixture: 'Salt + Water',
      image: 'ğŸ’§ğŸ§‚',
      correctMethod: 'evaporation',
      description: 'Evaporate water to get salt'
    },
    {
      mixture: 'Iron Filings + Sand',
      image: 'ğŸ§²ğŸ–',
      correctMethod: 'magnet',
      description: 'Use magnet to attract iron'
    },
    {
      mixture: 'Chalk + Water',
      image: 'ğŸ’§ğŸ“',
      correctMethod: 'filtration',
      description: 'Filter chalk powder from water'
    }
  ];

  const methods = [
    { id: 'handpicking', name: 'Handpicking', icon: 'âœ‹', color: '#FF6B9D' },
    { id: 'filtration', name: 'Filtration', icon: 'ğŸ§ª', color: '#4ECDC4' },
    { id: 'sedimentation', name: 'Sedimentation', icon: 'â¬‡', color: '#95E1D3' },
    { id: 'decantation', name: 'Decantation', icon: 'ğŸ«—', color: '#FFD93D' },
    { id: 'evaporation', name: 'Evaporation', icon: 'â˜€', color: '#FFA07A' },
    { id: 'magnet', name: 'Magnet', icon: 'ğŸ§²', color: '#B565D8' }
  ];

  const playAnimation = (method) => {
    setIsAnimating(true);
    setAnimationState(method);
    
    setTimeout(() => {
      setShowSuccess(true);
      createConfetti();
      
      setTimeout(() => {
        setShowSuccess(false);
        setAnimationState('idle');
        setIsAnimating(false);
        
        if (currentLevel < levels.length - 1) {
          setCurrentLevel(currentLevel + 1);
        } else {
          setGameComplete(true);
          createMassiveConfetti();
        }
      }, 2000);
    }, 2500);
  };

  const createConfetti = () => {
    const newConfetti = Array.from({ length: 30 }, (_, i) => ({
      id: Date.now() + i,
      x: Math.random() * 100,
      delay: Math.random() * 0.5,
      duration: 1 + Math.random() * 1
    }));
    setConfetti(newConfetti);
    setTimeout(() => setConfetti([]), 2000);
  };

  const createMassiveConfetti = () => {
    const newConfetti = Array.from({ length: 100 }, (_, i) => ({
      id: Date.now() + i,
      x: Math.random() * 100,
      delay: Math.random() * 1,
      duration: 2 + Math.random() * 2
    }));
    setConfetti(newConfetti);
  };

  const handleDragStart = (e, methodId) => {
    if (isAnimating) return;
    setDraggedMethod(methodId);
    dragRef.current.isDragging = true;
    
    const rect = e.currentTarget.getBoundingClientRect();
    dragRef.current.offsetX = e.clientX - rect.left;
    dragRef.current.offsetY = e.clientY - rect.top;
  };

  const handleDrop = (methodId) => {
    if (!draggedMethod || isAnimating) return;

    const level = levels[currentLevel];
    const isCorrect = methodId === level.correctMethod || methodId === level.alternateMethod;

    if (isCorrect) {
      playAnimation(methodId);
    } else {
      setAnimationState('error');
      setTimeout(() => setAnimationState('idle'), 600);
    }

    setDraggedMethod(null);
  };

  const handleHint = () => {
    setShowHint(true);
    setTimeout(() => setShowHint(false), 1500);
  };

  const renderAnimation = () => {
    const level = levels[currentLevel];
    
    switch(animationState) {
      case 'handpicking':
        return (
          <div className="absolute inset-0 flex items-center justify-center">
            <div className="relative">
              <div className="text-8xl animate-bounce">{level.image}</div>
              <div className="absolute -top-10 left-1/2 transform -translate-x-1/2 text-6xl animate-pulse">
                âœ‹
              </div>
              <div className="absolute top-0 left-0 text-4xl animate-ping">âœ¨</div>
            </div>
          </div>
        );
      
      case 'filtration':
        return (
          <div className="absolute inset-0 flex flex-col items-center justify-center">
            <div className="relative">
              <div className="text-6xl mb-4 animate-pulse">ğŸ§ª</div>
              <div className="text-8xl opacity-80">{level.image}</div>
              <div className="absolute top-20 left-1/2 transform -translate-x-1/2">
                <div className="text-4xl animate-bounce" style={{animationDelay: '0.1s'}}>ğŸ’§</div>
              </div>
              <div className="absolute top-28 left-1/2 transform -translate-x-1/2">
                <div className="text-4xl animate-bounce" style={{animationDelay: '0.2s'}}>ğŸ’§</div>
              </div>
            </div>
          </div>
        );
      
      case 'sedimentation':
        return (
          <div className="absolute inset-0 flex items-center justify-center">
            <div className="relative w-64 h-64">
              <div className="absolute top-0 left-1/2 transform -translate-x-1/2 text-6xl animate-float">
                ğŸ’§
              </div>
              <div className="absolute bottom-0 left-1/2 transform -translate-x-1/2 text-8xl animate-settle">
                ğŸ–
              </div>
              <div className="absolute bottom-10 left-1/2 transform -translate-x-1/2 text-2xl animate-ping">
                â¬‡â¬‡â¬‡
              </div>
            </div>
          </div>
        );
      
      case 'evaporation':
        return (
          <div className="absolute inset-0 flex items-center justify-center">
            <div className="relative">
              <div className="text-8xl animate-pulse">{level.image}</div>
              <div className="absolute -top-10 left-1/2 transform -translate-x-1/2 text-6xl animate-float">
                â˜€
              </div>
              <div className="absolute top-0 left-0 text-4xl animate-vapor opacity-0">ğŸ’¨</div>
              <div className="absolute top-0 right-0 text-4xl animate-vapor opacity-0" style={{animationDelay: '0.3s'}}>ğŸ’¨</div>
              <div className="absolute bottom-0 text-6xl animate-bounce">ğŸ§‚</div>
            </div>
          </div>
        );
      
      case 'magnet':
        return (
          <div className="absolute inset-0 flex items-center justify-center">
            <div className="relative">
              <div className="text-8xl">{level.image}</div>
              <div className="absolute -top-16 left-1/2 transform -translate-x-1/2 text-7xl animate-magnetic">
                ğŸ§²
              </div>
              <div className="absolute top-5 left-1/2 transform -translate-x-1/2 text-3xl animate-attract">
                âš¡âš¡âš¡
              </div>
            </div>
          </div>
        );
      
      case 'decantation':
        return (
          <div className="absolute inset-0 flex items-center justify-center">
            <div className="relative">
              <div className="text-8xl animate-tilt">{level.image}</div>
              <div className="absolute top-0 right-0 text-5xl animate-pour">ğŸ«—</div>
            </div>
          </div>
        );
      
      case 'error':
        return (
          <div className="absolute inset-0 flex items-center justify-center">
            <div className="text-8xl animate-shake-error bg-red-500 bg-opacity-30 rounded-full p-8">
              {level.image}
            </div>
          </div>
        );
      
      default:
        return (
          <div className="text-8xl animate-pulse">{level.image}</div>
        );
    }
  };

  if (gameComplete) {
    return (
      <div className="w-full h-screen bg-gradient-to-br from-purple-400 via-pink-400 to-blue-400 flex items-center justify-center overflow-hidden relative">
        {confetti.map(c => (
          <div
            key={c.id}
            className="absolute top-0 text-4xl animate-confetti-fall"
            style={{
              left: ${c.x}%,
              animationDelay: ${c.delay}s,
              animationDuration: ${c.duration}s
            }}
          >
            {['ğŸ‰', 'â­', 'âœ¨', 'ğŸŠ', 'ğŸŒŸ'][Math.floor(Math.random() * 5)]}
          </div>
        ))}
        
        <div className="bg-white rounded-3xl p-12 shadow-2xl text-center z-10 transform animate-bounce-in">
          <Trophy className="w-32 h-32 mx-auto mb-6 text-yellow-500 animate-spin-slow" />
          <h1 className="text-5xl font-bold text-gray-800 mb-4">ğŸ‰ Amazing Work! ğŸ‰</h1>
          <p className="text-2xl text-gray-600 mb-8">You've mastered all separation methods!</p>
          <div className="text-6xl mb-6">ğŸ†</div>
          <button
            onClick={() => {
              setGameComplete(false);
              setCurrentLevel(0);
              setConfetti([]);
            }}
            className="bg-gradient-to-r from-purple-500 to-pink-500 text-white text-xl px-8 py-4 rounded-full font-bold hover:scale-110 transform transition shadow-lg"
          >
            Play Again! ğŸ”„
          </button>
        </div>
      </div>
    );
  }

  const level = levels[currentLevel];

  return (
    <div className="w-full h-screen bg-gradient-to-br from-blue-200 via-purple-200 to-pink-200 overflow-hidden">
      <style>{`
        @keyframes float {
          0%, 100% { transform: translateY(0px); }
          50% { transform: translateY(-20px); }
        }
        @keyframes settle {
          0% { transform: translateY(-100px); opacity: 0; }
          100% { transform: translateY(0px); opacity: 1; }
        }
        @keyframes vapor {
          0% { transform: translateY(0) scale(1); opacity: 0.5; }
          100% { transform: translateY(-100px) scale(2); opacity: 0; }
        }
        @keyframes magnetic {
          0%, 100% { transform: translateY(0) rotate(0deg); }
          50% { transform: translateY(-10px) rotate(10deg); }
        }
        @keyframes attract {
          0% { transform: scale(1); opacity: 1; }
          100% { transform: scale(0.5) translateY(-50px); opacity: 0; }
        }
        @keyframes shake-error {
          0%, 100% { transform: translateX(0) rotate(0deg); }
          25% { transform: translateX(-10px) rotate(-5deg); }
          75% { transform: translateX(10px) rotate(5deg); }
        }
        @keyframes tilt {
          0%, 100% { transform: rotate(0deg); }
          50% { transform: rotate(15deg); }
        }
        @keyframes pour {
          0% { transform: translateX(0) rotate(0deg); }
          100% { transform: translateX(50px) rotate(45deg); }
        }
        @keyframes confetti-fall {
          0% { transform: translateY(0) rotate(0deg); opacity: 1; }
          100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        @keyframes bounce-in {
          0% { transform: scale(0); }
          50% { transform: scale(1.1); }
          100% { transform: scale(1); }
        }
        @keyframes spin-slow {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        .animate-float { animation: float 2s ease-in-out infinite; }
        .animate-settle { animation: settle 1.5s ease-out forwards; }
        .animate-vapor { animation: vapor 2s ease-out forwards; }
        .animate-magnetic { animation: magnetic 1s ease-in-out infinite; }
        .animate-attract { animation: attract 1.5s ease-out forwards; }
        .animate-shake-error { animation: shake-error 0.5s ease-in-out; }
        .animate-tilt { animation: tilt 2s ease-in-out forwards; }
        .animate-pour { animation: pour 2s ease-out forwards; }
        .animate-confetti-fall { animation: confetti-fall linear forwards; }
        .animate-bounce-in { animation: bounce-in 0.6s ease-out; }
        .animate-spin-slow { animation: spin-slow 3s linear infinite; }
      `}</style>

      {/* Header */}
      <div className="p-6 flex justify-between items-center">
        <div className="flex items-center gap-3">
          <Sparkles className="w-8 h-8 text-yellow-500 animate-pulse" />
          <h1 className="text-3xl font-bold text-gray-800">Mixture Lab Puzzle</h1>
        </div>
        <button
          onClick={handleHint}
          disabled={isAnimating}
          className="bg-yellow-400 hover:bg-yellow-500 text-gray-800 px-6 py-3 rounded-full font-bold shadow-lg hover:scale-110 transform transition flex items-center gap-2"
        >
          <HelpCircle className="w-5 h-5" />
          Hint
        </button>
      </div>

      {/* Progress Bar */}
      <div className="px-6 mb-4">
        <div className="bg-white rounded-full p-2 shadow-lg">
          <div className="flex justify-between items-center mb-2 px-2">
            <span className="text-sm font-bold text-gray-600">Level {currentLevel + 1} / {levels.length}</span>
            <span className="text-xs text-gray-500">{level.description}</span>
          </div>
          <div className="h-4 bg-gray-200 rounded-full overflow-hidden">
            <div 
              className="h-full bg-gradient-to-r from-green-400 to-blue-500 transition-all duration-500 rounded-full"
              style={{ width: ${((currentLevel + 1) / levels.length) * 100}% }}
            />
          </div>
        </div>
      </div>

      {/* Confetti */}
      {confetti.map(c => (
        <div
          key={c.id}
          className="absolute top-0 text-3xl animate-confetti-fall pointer-events-none"
          style={{
            left: ${c.x}%,
            animationDelay: ${c.delay}s,
            animationDuration: ${c.duration}s
          }}
        >
          {['ğŸ‰', 'â­', 'âœ¨', 'ğŸŠ', 'ğŸŒŸ'][Math.floor(Math.random() * 5)]}
        </div>
      ))}

      {/* Main Game Area */}
      <div className="flex flex-col items-center justify-center h-[calc(100vh-220px)] px-6">
        {/* Mixture Bowl */}
        <div className="mb-8">
          <h2 className="text-2xl font-bold text-gray-700 mb-4 text-center">
            {level.mixture}
          </h2>
          <div
            ref={bowlRef}
            onDragOver={(e) => e.preventDefault()}
            onDrop={(e) => {
              e.preventDefault();
              handleDrop(draggedMethod);
            }}
            className={`w-80 h-80 bg-gradient-to-br from-blue-100 to-purple-100 rounded-full border-8 border-white shadow-2xl flex items-center justify-center relative transition-all ${
              draggedMethod ? 'scale-105 ring-8 ring-yellow-400 ring-opacity-50' : ''
            } ${animationState === 'error' ? 'animate-shake-error' : ''}`}
          >
            {renderAnimation()}
            
            {!isAnimating && (
              <div className="absolute bottom-4 text-sm text-gray-500 font-semibold">
                Drop method here
              </div>
            )}
          </div>
        </div>

        {/* Success Message */}
        {showSuccess && (
          <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-green-500 text-white px-8 py-4 rounded-full text-3xl font-bold shadow-2xl animate-bounce-in z-20">
            ğŸ‰ Separated! ğŸ‰
          </div>
        )}

        {/* Method Icons */}
        <div className="grid grid-cols-6 gap-4 max-w-4xl">
          {methods.map((method) => {
            const isCorrect = method.id === level.correctMethod || method.id === level.alternateMethod;
            const shouldHighlight = showHint && isCorrect;
            
            return (
              <div
                key={method.id}
                draggable={!isAnimating}
                onDragStart={(e) => handleDragStart(e, method.id)}
                onDragEnd={() => setDraggedMethod(null)}
                className={`
                  bg-white rounded-2xl p-4 shadow-lg cursor-grab active:cursor-grabbing
                  transform transition-all hover:scale-110 hover:-translate-y-2
                  flex flex-col items-center gap-2 select-none
                  ${draggedMethod === method.id ? 'opacity-50 scale-95' : ''}
                  ${shouldHighlight ? 'ring-8 ring-yellow-400 animate-pulse scale-110' : ''}
                  ${isAnimating ? 'cursor-not-allowed opacity-50' : ''}
                `}
                style={{ 
                  borderTop: 4px solid ${method.color},
                  touchAction: 'none'
                }}
              >
                <div className="text-4xl">{method.icon}</div>
                <span className="text-xs font-bold text-gray-700 text-center">{method.name}</span>
              </div>
            );
          })}
        </div>
      </div>
    </div>
  );
};

export default MixtureLabGame;